# AI応答とアクションのリンク機能

このドキュメントでは、PiVotにおけるAI応答とロボットアクションのリンク機能について説明します。

## 概要

AIの応答に基づいてロボットが自動的にアクションを実行できるようになりました。AIは応答内に特別なタグを使用して、音声出力とアクション実行を分離します。

## 使用されるタグ

### 1. `<response>` タグ
音声合成で読み上げるテキストを囲みます。

```
<response>カメラを右に移動します。</response>
```

### 2. `<code>` タグ
実行するPythonコードを囲みます。

```
<code>cam_move(shaft='z', angle=110)</code>
```

## 利用可能な関数

### cam_move(shaft, angle)
カメラ（サーボ）を指定した軸と角度に移動します。

**パラメータ:**
- `shaft` (str): 軸の指定
  - `'z'`: Z軸（水平旋回、左右）- CH0
  - `'x'`: X軸（上下移動）- CH1
- `angle` (int/float): 目標角度（0-180度）

**例:**
```python
# 正面を向く（90度）
cam_move(shaft='z', angle=90)

# 右端を向く（180度）
cam_move(shaft='z', angle=180)

# 上を向く（180度）
cam_move(shaft='x', angle=180)

# 下を向く（0度）
cam_move(shaft='x', angle=0)
```

**角度の目安:**

Z軸（水平）:
- 0度: 左端
- 90度: 正面（中央）
- 180度: 右端

X軸（上下）:
- 0度: 下端
- 90度: 水平（中央）
- 180度: 上端

### url(url_string)
指定されたURLのQRコードを生成して表示します。

**パラメータ:**
- `url_string` (str): QRコード化するURL

**例:**
```python
# GoogleのQRコードを表示
url("https://www.google.com")

# YouTubeのQRコードを表示
url("https://www.youtube.com")
```

## AI応答の例

### 例1: カメラを右に移動
```
<response>カメラを右に20度移動します。</response>
<code>cam_move(shaft='z', angle=110)</code>
```

### 例2: 複数のアクション
```
<response>右上隅を見ます。</response>
<code>cam_move(shaft='z', angle=150)</code>
<code>cam_move(shaft='x', angle=150)</code>
```

### 例3: URLの表示
```
<response>GoogleのQRコードを表示します。</response>
<code>url("https://www.google.com")</code>
```

### 例4: アクションなし
```
<response>それは青いコップです。</response>
```

## 処理フロー

1. **AI応答の受信**: GeminiからAI応答を受け取ります
2. **タグの解析**: 
   - `<response>` タグから音声出力用テキストを抽出
   - `<code>` タグからアクションコードを抽出
3. **アクションの実行**: 抽出されたコードを安全に実行
4. **音声出力**: `<response>` タグ内のテキストをAquesTalkPiで読み上げ

## セキュリティ

コード実行は制限された環境で行われます:
- 許可された関数のみ実行可能（`cam_move`, `url`）
- Pythonの組み込み関数は使用不可
- ファイルシステムへのアクセスは制限

## テクニカル詳細

### サーボ制御の仕様
- **PWM周波数**: 50Hz
- **チャンネルマッピング**:
  - CH0: Z軸（水平旋回）
  - CH1: X軸（上下移動）
- **パルス幅範囲**: 500μs（0度）〜 2500μs（180度）

### Pi Servo Hat
Pi Servo Hatライブラリを使用してサーボを制御します。ライブラリが利用できない場合は、シミュレーションモードで動作します。

## ファイル構成

- `servo_control.py`: サーボ制御とアクション関数を提供
- `main.py`: AI応答の解析と実行ロジックを含むメインプログラム
- `test_minimal.py`: 応答解析のテストスクリプト
- `RAG.txt`: AIプロンプトとアクション例のデータベース

## トラブルシューティング

### サーボが動かない
1. Pi Servo Hatが正しく接続されているか確認
2. `pi_servo_hat` ライブラリがインストールされているか確認
3. シミュレーションモードの警告メッセージを確認

### QRコードが表示されない
1. `qrcode` ライブラリがインストールされているか確認: `pip install qrcode[pil]`
2. 画像ビューア（feh、display等）がインストールされているか確認

### コードが実行されない
1. AI応答に `<code>` タグが含まれているか確認
2. ログ出力でエラーメッセージを確認
3. 関数名とパラメータが正しいか確認

## 今後の拡張

- より多くのアクション関数の追加
- より複雑なシーケンス制御
- エラーハンドリングの改善
- ハードウェアフィードバックの統合
